name: Project Health Check

on:
  schedule:
    - cron: '0 11 * * 0'  # Every Sunday at 11 AM
  workflow_dispatch:

jobs:
  health:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate health report
        run: |
          echo "Project health check started at $(date)" > health-report.txt
          
          # Overall health score
          health_score=100
          
          echo "=== Project Health Score ===" >> health-report.txt
          echo "Starting score: $health_score" >> health-report.txt

      - name: Check build health
        run: |
          echo "" >> health-report.txt
          echo "=== Build Health ===" >> health-report.txt
          
          # Test if build works
          if npm run build; then
            echo "âœ… Build successful" >> health-report.txt
          else
            echo "âŒ Build failed" >> health-report.txt
            health_score=$((health_score - 20))
          fi
          
          # Check for build artifacts
          if [ -f "main.js" ] && [ -f "manifest.json" ] && [ -f "styles.css" ]; then
            echo "âœ… All build artifacts present" >> health-report.txt
          else
            echo "âŒ Missing build artifacts" >> health-report.txt
            health_score=$((health_score - 10))
          fi

      - name: Check code quality health
        run: |
          echo "" >> health-report.txt
          echo "=== Code Quality Health ===" >> health-report.txt
          
          # Check linting
          if npm run lint; then
            echo "âœ… Linting passed" >> health-report.txt
          else
            echo "âŒ Linting failed" >> health-report.txt
            health_score=$((health_score - 15))
          fi
          
          # Check formatting
          if npm run format:check; then
            echo "âœ… Formatting passed" >> health-report.txt
          else
            echo "âŒ Formatting failed" >> health-report.txt
            health_score=$((health_score - 5))
          fi
          
          # Check type checking
          if npm run type-check; then
            echo "âœ… Type checking passed" >> health-report.txt
          else
            echo "âŒ Type checking failed" >> health-report.txt
            health_score=$((health_score - 15))
          fi

      - name: Check documentation health
        run: |
          echo "" >> health-report.txt
          echo "=== Documentation Health ===" >> health-report.txt
          
          # Check for essential documentation
          if [ -f "README.md" ]; then
            echo "âœ… README.md present" >> health-report.txt
          else
            echo "âŒ README.md missing" >> health-report.txt
            health_score=$((health_score - 10))
          fi
          
          if [ -f "docs/" ]; then
            echo "âœ… Documentation directory present" >> health-report.txt
          else
            echo "âŒ Documentation directory missing" >> health-report.txt
            health_score=$((health_score - 5))
          fi
          
          if [ -f "CHANGELOG.md" ]; then
            echo "âœ… CHANGELOG.md present" >> health-report.txt
          else
            echo "âŒ CHANGELOG.md missing" >> health-report.txt
            health_score=$((health_score - 5))
          fi

      - name: Check security health
        run: |
          echo "" >> health-report.txt
          echo "=== Security Health ===" >> health-report.txt
          
          # Check for security policy
          if [ -f "SECURITY.md" ]; then
            echo "âœ… SECURITY.md present" >> health-report.txt
          else
            echo "âŒ SECURITY.md missing" >> health-report.txt
            health_score=$((health_score - 5))
          fi
          
          # Check for vulnerabilities
          if npm audit --audit-level=moderate; then
            echo "âœ… No moderate+ vulnerabilities" >> health-report.txt
          else
            echo "âŒ Security vulnerabilities found" >> health-report.txt
            health_score=$((health_score - 20))
          fi

      - name: Check community health
        run: |
          echo "" >> health-report.txt
          echo "=== Community Health ===" >> health-report.txt
          
          # Check for contributing guidelines
          if [ -f "CONTRIBUTING.md" ]; then
            echo "âœ… CONTRIBUTING.md present" >> health-report.txt
          else
            echo "âŒ CONTRIBUTING.md missing" >> health-report.txt
            health_score=$((health_score - 5))
          fi
          
          # Check for code of conduct
          if [ -f "CODE_OF_CONDUCT.md" ]; then
            echo "âœ… CODE_OF_CONDUCT.md present" >> health-report.txt
          else
            echo "âŒ CODE_OF_CONDUCT.md missing" >> health-report.txt
            health_score=$((health_score - 5))
          fi

      - name: Final health score
        run: |
          echo "" >> health-report.txt
          echo "=== Final Health Score ===" >> health-report.txt
          echo "Final score: $health_score/100" >> health-report.txt
          
          if [ $health_score -ge 90 ]; then
            echo "Status: ðŸŸ¢ Excellent" >> health-report.txt
          elif [ $health_score -ge 80 ]; then
            echo "Status: ðŸŸ¡ Good" >> health-report.txt
          elif [ $health_score -ge 70 ]; then
            echo "Status: ðŸŸ  Fair" >> health-report.txt
          else
            echo "Status: ðŸ”´ Needs attention" >> health-report.txt
          fi

      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: health-report
          path: health-report.txt
          retention-days: 7